// ===========================================================
// GENERATOR & DATASOURCE
// ===========================================================
generator client {
  provider = "prisma-client"
  output   = "./generated/client"
}

datasource db {
  provider = "postgresql"
  // URLs handled in prisma.config.ts
}

// ===========================================================
// ENUMS
// ===========================================================
enum UserRole {
  USER
  RECRUITER
  ORGANIZATION
  ADMIN
}

enum JobPlatform {
  LINKEDIN
  FIVERR
  UPWORK
  INDEED
  GLASSDOOR
  ADZUNA
  JSEARCH
  THE_MUSE
  COMPANY_WEBSITE
  REFERRAL
  PASTED        // Manually pasted job
  OTHER
}

enum ApplicationStatus {
  WISHLIST      // Saved/bookmarked jobs
  APPLIED       // Application submitted
  INTERVIEWING  // In interview process
  OFFERED       // Received job offer
  REJECTED      // Application rejected
  ACCEPTED      // Offer accepted
  WITHDRAWN     // User withdrew application
}

// ===========================================================
// USER (Auth + Global Relations)
// ===========================================================
model User {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email           String    @unique
  role            UserRole  @default(USER)

  // Relations
  profile           Profile?
  resumes           Resume[]
  jobApplications   JobApplication[]
  preferences       JobSearchPreference?
  notifications     Notification[]
  aiContents        AIGeneratedContent[]
  coverLetters      CoverLetter[]
  emailApplications EmailApplication[]

  // Onboarding state
  onboardingStep  Int       @default(0)   // 0 = fresh user, 1-5 steps...
  isOnboarded     Boolean   @default(false)

  createdAt       DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime  @default(now()) @updatedAt @db.Timestamptz(6)

  @@map("users")
}

// ===========================================================
// PROFILE (Extended User Data + Resume-derived fields)
// ===========================================================
model Profile {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String   @unique @db.Uuid

  // Core personal info
  firstName       String?
  lastName        String?
  phone           String?
  location        String?
  bio             String?
  headline        String?

  // Socials
  website         String?
  linkedinUrl     String?
  githubUrl       String?
  twitterUrl      String?

  avatarUrl       String?
  resumeUrl       String?     // Last uploaded resume

  // Profile completeness
  completionScore Int       @default(0)
  isComplete      Boolean   @default(false)

  // Language list
  languages       String[]    // JSON array of languages like ["English", "French"]

  // Relations
  skills          Skill[]
  experiences     Experience[]
  educations      Education[]
  certifications  Certification[]
  projects        Project[]
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime    @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime    @default(now()) @updatedAt @db.Timestamptz(6)

  @@map("profiles")
}

// ===========================================================
// RESUME STORAGE (multiple resumes for users)
// ===========================================================
model Resume {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String   @db.Uuid

  fileUrl     String
  fileName    String
  fileType    String
  fileSize    Int

  isActive    Boolean  @default(true)

  parsedData  Json?    // Resume parser data storage

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@map("resumes")
}

// ===========================================================
// PROFILE SUB-SECTIONS (Highly scalable, normalized)
// ===========================================================
model Skill {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  profileId   String   @db.Uuid
  name        String
  level       Int?       // 1–5 skill rating
  category    String?    // e.g., “Backend”, “Cloud”, etc.

  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@map("skills")
}

model Experience {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  profileId   String   @db.Uuid

  title       String
  company     String
  location    String?
  startDate   DateTime
  endDate     DateTime?
  isCurrent   Boolean  @default(false)
  description String?

  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@map("experiences")
}

model Education {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  profileId   String   @db.Uuid

  institution String
  degree      String
  field       String
  startDate   DateTime
  endDate     DateTime?
  isCurrent   Boolean  @default(false)
  description String?

  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@map("educations")
}

model Certification {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  profileId     String   @db.Uuid

  name          String
  issuer        String
  issueDate     DateTime
  expiryDate    DateTime?
  credentialUrl String?

  profile       Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@map("certifications")
}

model Project {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  profileId   String   @db.Uuid

  name        String
  description String
  url         String?
  startDate   DateTime
  endDate     DateTime?
  isCurrent   Boolean  @default(false)

  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@map("projects")
}

// ===========================================================
// JOB APPLYING MODULE
// ===========================================================
model JobApplication {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String            @db.Uuid

  // Core Job Details
  jobTitle        String
  company         String
  location        String?
  jobType         String?           // Full-time, Part-time, Contract, Remote, Hybrid
  salary          String?           // Salary range as string (e.g., "$80k-$120k")
  description     String?           @db.Text
  requirements    String?           @db.Text
  jobPostUrl      String?

  // Application Tracking
  status          ApplicationStatus @default(WISHLIST)
  appliedDate     DateTime?         @db.Timestamptz(6)  // When user actually applied
  source          JobPlatform?      // Where the job came from
  notes           String?           @db.Text            // User's notes about this job
  
  // External Job Data (if from API)
  externalJobId   String?           // Job ID from external source
  externalSource  String?           // API source name (adzuna, jsearch, etc.)
  externalData    Json?             // Raw data from API for reference
  
  // Contact & Follow-up
  contactName     String?           // Recruiter/hiring manager name
  contactEmail    String?           // Contact email
  contactPhone    String?           // Contact phone
  
  // Interview Tracking
  interviewDate   DateTime?         @db.Timestamptz(6)
  interviewNotes  String?           @db.Text
  
  // Offer Details
  offerAmount     String?           // Actual offer amount
  offerDeadline   DateTime?         @db.Timestamptz(6)
  
  // Metadata
  isPasted        Boolean           @default(false)     // True if manually pasted
  isFavorite      Boolean           @default(false)     // Star/favorite flag
  reminderDate    DateTime?         @db.Timestamptz(6)  // Follow-up reminder
  
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime          @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime          @default(now()) @updatedAt @db.Timestamptz(6)

  @@index([userId])
  @@index([status])
  @@index([userId, status])
  @@map("job_applications")
}

// ===========================================================
// JOB SEARCH PREFERENCES
// ===========================================================
model JobSearchPreference {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String   @unique @db.Uuid

  // Search Keywords
  jobTitles       String[] // preferred titles (e.g., ["Software Engineer", "Full Stack Developer"])
  keywords        String[] // additional keywords (e.g., ["React", "Node.js"])
  
  // Location Preferences
  locations       String[] // preferred locations (e.g., ["San Francisco", "Remote"])
  
  // Salary Range
  minSalary       Int?
  maxSalary       Int?
  currency        String?  @default("USD")
  
  // Experience & Level
  experienceLevel String?  // entry, mid, senior, lead, executive
  yearsExperience Int?     // Minimum years of experience
  
  // Job Type Preferences
  workTypes       String[] // ["full-time", "part-time", "contract", "freelance"]
  remoteOptions   String[] // ["remote", "hybrid", "on-site"]
  
  // Skills & Requirements
  skills          String[] // Required/preferred skills
  
  // Industry & Company Preferences
  industries      String[] // Preferred industries
  companySize     String[] // ["startup", "small", "medium", "large", "enterprise"]
  excludeCompanies String[] // Companies to exclude from search
  
  // Search Settings
  autoSearch      Boolean  @default(false) // Auto-search for matching jobs
  notifyOnMatch   Boolean  @default(true)  // Send notifications for matches
  searchFrequency String?  @default("daily") // daily, weekly, manual
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@map("job_search_preferences")
}

// ===========================================================
// CACHED JOB RECOMMENDATIONS (Daily refresh, personalized)
// ===========================================================
model CachedJobRecommendation {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String   @db.Uuid
  
  // Job data (stored as JSON for flexibility)
  jobs            Json     // Array of NormalizedJob objects
  
  // Recommendation metadata
  matchScore      Float?   // Overall match score for the batch
  searchQuery     String?  // Query used to fetch these jobs
  sources         String[] // Which APIs were used
  
  // Cache control
  expiresAt       DateTime @db.Timestamptz(6) // When to refresh (next day)
  lastRefreshedAt DateTime @default(now()) @db.Timestamptz(6)
  
  createdAt       DateTime @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([userId])
  @@index([userId, expiresAt])
  @@map("cached_job_recommendations")
}

// ===========================================================
// AI GENERATED CONTENT (Cover letters, resumes, summaries, etc.)
// ===========================================================
model AIGeneratedContent {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String   @db.Uuid

  type        String   // “cover_letter”, “summary”, etc.
  prompt      String
  content     String   @db.Text
  model       String   // “gpt-4.1”, “deepseek-r1”, etc.
  metadata    Json?

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@map("ai_generated_content")
}

// ===========================================================
// COVER LETTERS (AI-generated, linked to job applications)
// ===========================================================
model CoverLetter {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String   @db.Uuid
  jobApplicationId  String?  // Optional link to job application
  
  // Content
  content           String   @db.Text
  subject           String?  // Email subject line
  
  // Generation metadata
  aiModel           String?  // "gpt-4", "deepseek", etc.
  promptUsed        String?  @db.Text
  tone              String?  // "professional", "friendly", "formal"
  
  // Status
  isDefault         Boolean  @default(false) // User's default template
  isSent            Boolean  @default(false)
  
  // Relations
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  emailApplications EmailApplication[]
  
  createdAt         DateTime @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@index([userId])
  @@index([jobApplicationId])
  @@map("cover_letters")
}

// ===========================================================
// EMAIL APPLICATIONS (Auto-sent job applications)
// ===========================================================
model EmailApplication {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String   @db.Uuid
  jobApplicationId  String   // Link to job application
  coverLetterId     String?  @db.Uuid // Link to cover letter used
  
  // Recipient info
  recipientEmail    String
  recipientName     String?
  companyName       String
  
  // Email content
  subject           String
  body              String   @db.Text
  
  // Attachments
  resumeUrl         String?  // URL to attached resume
  attachments       Json?    // Array of attachment info
  
  // Status tracking
  status            String   @default("draft") // draft, queued, sent, delivered, opened, failed
  sentAt            DateTime?
  deliveredAt       DateTime?
  openedAt          DateTime?
  failureReason     String?
  
  // Email service tracking
  emailServiceId    String?  // ID from email service (Resend, etc.)
  emailServiceResponse Json?
  
  // Relations
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  coverLetter       CoverLetter? @relation(fields: [coverLetterId], references: [id])
  
  createdAt         DateTime @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@index([userId])
  @@index([jobApplicationId])
  @@index([status])
  @@map("email_applications")
}

// ===========================================================
// NOTIFICATIONS SYSTEM
// ===========================================================
model Notification {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String   @db.Uuid

  type        String   // “job_match”, “reminder”
  title       String
  message     String
  isRead      Boolean  @default(false)
  link        String?

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@map("notifications")
}
