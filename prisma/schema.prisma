// ===========================================================
// GENERATOR & DATASOURCE
// ===========================================================
generator client {
  provider = "prisma-client"
  output   = "./generated/client"
}

datasource db {
  provider = "postgresql"
  // URL handled in prisma.config.ts (Supabase)
}

// ===========================================================
// ENUMS
// ===========================================================
enum UserRole {
  USER
  RECRUITER
  ORGANIZATION
  ADMIN
}

enum JobPlatform {
  LINKEDIN
  FIVERR
  UPWORK
  INDEED
  OTHER
}

enum ApplicationStatus {
  PENDING
  SENT
  VIEWED
  REPLIED
  REJECTED
  ACCEPTED
}

// ===========================================================
// USER (Auth + Global Relations)
// ===========================================================
model User {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email           String    @unique
  role            UserRole  @default(USER)

  // Relations
  profile         Profile?
  resumes         Resume[]
  jobApplications JobApplication[]
  preferences     JobSearchPreference?
  notifications   Notification[]
  aiContents      AIGeneratedContent[]

  // Onboarding state
  onboardingStep  Int       @default(0)   // 0 = fresh user, 1-5 steps...
  isOnboarded     Boolean   @default(false)

  createdAt       DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @db.Timestamptz(6)

  @@map("users")
}

// ===========================================================
// PROFILE (Extended User Data + Resume-derived fields)
// ===========================================================
model Profile {
  id              String   @id @default(cuid())
  userId          String   @unique @db.Uuid

  // Core personal info
  firstName       String?
  lastName        String?
  phone           String?
  location        String?
  bio             String?
  headline        String?

  // Socials
  website         String?
  linkedinUrl     String?
  githubUrl       String?
  twitterUrl      String?

  avatarUrl       String?
  resumeUrl       String?     // Last uploaded resume

  // Profile completeness
  completionScore Int       @default(0)
  isComplete      Boolean   @default(false)

  // Language list
  languages       String[]    // JSON array of languages like ["English", "French"]

  // Relations
  skills          Skill[]
  experiences     Experience[]
  educations      Education[]
  certifications  Certification[]
  projects        Project[]
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime    @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime    @updatedAt @db.Timestamptz(6)

  @@map("profiles")
}

// ===========================================================
// RESUME STORAGE (multiple resumes for users)
// ===========================================================
model Resume {
  id          String   @id @default(cuid())
  userId      String   @db.Uuid

  fileUrl     String
  fileName    String
  fileType    String
  fileSize    Int

  isActive    Boolean  @default(true)

  parsedData  Json?    // Resume parser data storage

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)

  @@map("resumes")
}

// ===========================================================
// PROFILE SUB-SECTIONS (Highly scalable, normalized)
// ===========================================================
model Skill {
  id          String   @id @default(cuid())
  profileId   String
  name        String
  level       Int?       // 1–5 skill rating
  category    String?    // e.g., “Backend”, “Cloud”, etc.

  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)

  @@map("skills")
}

model Experience {
  id          String   @id @default(cuid())
  profileId   String

  title       String
  company     String
  location    String?
  startDate   DateTime
  endDate     DateTime?
  isCurrent   Boolean  @default(false)
  description String?

  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)

  @@map("experiences")
}

model Education {
  id          String   @id @default(cuid())
  profileId   String

  institution String
  degree      String
  field       String
  startDate   DateTime
  endDate     DateTime?
  isCurrent   Boolean  @default(false)
  description String?

  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)

  @@map("educations")
}

model Certification {
  id            String   @id @default(cuid())
  profileId     String

  name          String
  issuer        String
  issueDate     DateTime
  expiryDate    DateTime?
  credentialUrl String?

  profile       Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @db.Timestamptz(6)

  @@map("certifications")
}

model Project {
  id          String   @id @default(cuid())
  profileId   String

  name        String
  description String
  url         String?
  startDate   DateTime
  endDate     DateTime?
  isCurrent   Boolean  @default(false)

  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)

  @@map("projects")
}

// ===========================================================
// JOB APPLYING MODULE
// ===========================================================
model JobApplication {
  id          String           @id @default(cuid())
  userId      String           @db.Uuid

  jobTitle    String
  company     String
  status      ApplicationStatus @default(PENDING)

  appliedAt   DateTime @default(now()) @db.Timestamptz(6)
  source      JobPlatform?
  jobPostUrl  String?
  notes       String?

  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)

  @@map("job_applications")
}

// ===========================================================
// JOB SEARCH PREFERENCES
// ===========================================================
model JobSearchPreference {
  id              String   @id @default(cuid())
  userId          String   @unique @db.Uuid

  jobTitles       String[] // preferred titles
  locations       String[] // preferred locations
  minSalary       Int?
  maxSalary       Int?
  experienceLevel String?
  workTypes       String[] // ["full-time", "contract"]
  remoteOptions   String[] // ["remote", "on-site"]
  skills          String[]

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @db.Timestamptz(6)

  @@map("job_search_preferences")
}

// ===========================================================
// AI GENERATED CONTENT (Cover letters, resumes, summaries, etc.)
// ===========================================================
model AIGeneratedContent {
  id          String   @id @default(cuid())
  userId      String   @db.Uuid

  type        String   // “cover_letter”, “summary”, etc.
  prompt      String
  content     String   @db.Text
  model       String   // “gpt-4.1”, “deepseek-r1”, etc.
  metadata    Json?

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)

  @@map("ai_generated_content")
}

// ===========================================================
// NOTIFICATIONS SYSTEM
// ===========================================================
model Notification {
  id          String   @id @default(cuid())
  userId      String   @db.Uuid

  type        String   // “job_match”, “reminder”
  title       String
  message     String
  isRead      Boolean  @default(false)
  link        String?

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)

  @@map("notifications")
}
