// app/(dashboard)/dashboard/profile/page.tsx
"use client"
import React, { useState, useEffect } from 'react';
import { useRouter } from "next/navigation";
import { FileText, Briefcase, GraduationCap, Award } from 'lucide-react';
import { getCurrentUser } from "@/lib/auth";
import { getProfileDetails, upsertProfile, updateCompletionScore } from "@/lib/actions/profile.action";
import { ProfileHeader } from '@/components/profile/ProfileHeader';
import { ProfileTabs } from '@/components/profile/ProfileTabs';
import { ProfileOverview } from '@/components/profile/ProfileOverview';
import { ResumePreviewModal } from '@/components/shared/ResumePreviewModal';

export default function ProfilePage() {
  const router = useRouter();
  const [isEditing, setIsEditing] = useState(false);
  const [activeTab, setActiveTab] = useState('overview');
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [profileCompletion, setProfileCompletion] = useState(0);
  const [isSaving, setIsSaving] = useState(false);
  const [isPreviewOpen, setIsPreviewOpen] = useState(false);

  // Profile data
  const [profile, setProfile] = useState({
    id: '',
    firstName: '',
    lastName: '',
    headline: '',
    email: '',
    phone: '',
    location: '',
    bio: '',
    website: '',
    linkedin: '',
    github: '',
    avatarUrl: null as string | null,
    resumeUrl: null as string | null,
  });

  const [experiences, setExperiences] = useState<any[]>([]);
  const [education, setEducation] = useState<any[]>([]);
  const [skills, setSkills] = useState<any[]>([]);
  const [certifications, setCertifications] = useState<any[]>([]);
  const [languages, setLanguages] = useState<any[]>([]);

  useEffect(() => {
    const loadProfile = async () => {
      try {
        setLoading(true);
        setError(null);

        const { user, error: userError } = await getCurrentUser();
        if (!user || userError) {
          router.push('/login');
          return;
        }

        const { data, error } = await getProfileDetails(user.id);
        if (!data || error) {
          setError(error || 'Profile not found');
          return;
        }

        const { profile: p, skills, experiences, educations, certifications } = data as any;

        setProfile(prev => ({
          ...prev,
          id: p.id || '',
          firstName: p.firstName || '',
          lastName: p.lastName || '',
          headline: p.headline || '',
          email: user.email || '',
          phone: p.phone || '',
          location: p.location || '',
          bio: p.bio || '',
          website: p.website || '',
          linkedin: p.linkedinUrl || '',
          github: p.githubUrl || '',
          avatarUrl: p.avatarUrl || null,
          resumeUrl: p.resumeUrl || null,
        }));

        setExperiences(
          (experiences || []).map((exp: any) => ({
            id: exp.id,
            title: exp.title,
            company: exp.company,
            location: exp.location,
            startDate: exp.startDate,
            endDate: exp.endDate,
            current: exp.isCurrent,
            description: exp.description,
          }))
        );

        setEducation(
          (educations || []).map((edu: any) => ({
            id: edu.id,
            degree: edu.degree,
            school: edu.institution,
            field: edu.field,
            startDate: edu.startDate,
            endDate: edu.endDate,
            current: edu.isCurrent,
            description: edu.description,
          }))
        );

        setSkills(
          (skills || []).map((skill: any) => ({
            id: skill.id,
            name: skill.name,
            level: typeof skill.level === 'number' ? skill.level : 3,
            category: skill.category || 'Technical',
          }))
        );

        setCertifications(
          (certifications || []).map((cert: any) => ({
            id: cert.id,
            name: cert.name,
            issuer: cert.issuer,
            issueDate: cert.issueDate,
            expirationDate: cert.expirationDate || null,
            credentialId: cert.credentialId,
            credentialUrl: cert.credentialUrl,
            isExpired: cert.expirationDate ? new Date(cert.expirationDate) < new Date() : false,
          }))
        );

        if (typeof p.completionScore === 'number') {
          setProfileCompletion(p.completionScore);
        }
      } catch (err) {
        setError('Failed to load profile');
      } finally {
        setLoading(false);
      }
    };

    loadProfile();
  }, [router]);

  const onInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target;
    setProfile(prev => ({ ...prev, [name]: value }));
  };

  const handleSaveProfile = async (updatedProfile: any) => {
    try {
      setIsSaving(true);
      setError(null);

      const payload = {
        ...updatedProfile,
        linkedinUrl: updatedProfile.linkedin,
        githubUrl: updatedProfile.github,
      };

      const { data, error } = await upsertProfile(payload);
      if (error) {
        setError(error);
        return;
      }

      const { data: completionData, error: completionError } = await updateCompletionScore();
      if (!completionError && completionData?.completionScore !== undefined) {
        setProfileCompletion(completionData.completionScore);
      }

      setIsEditing(false);
    } catch (err) {
      setError('Failed to save profile');
    } finally {
      setIsSaving(false);
    }
  };

  const handleAddItem = (type: string) => {
    // Handle adding new items
    console.log('Add new', type);
  };

  const handleEditItem = (type: string, id: string) => {
    // Handle editing items
    console.log('Edit', type, id);
  };

  const handleDeleteItem = (type: string, id: string) => {
    // Handle deleting items
    console.log('Delete', type, id);
  };

  const handlePreview = () => {
    setIsPreviewOpen(true);
  };

  const formatDate = (dateString: any) => {
    if (!dateString) return 'Present';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="h-8 w-8 rounded-full border-4 border-indigo-500 border-t-transparent animate-spin" />
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="px-4 py-3 rounded-lg bg-red-50 text-red-700 border border-red-200 text-sm">
          {error}
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
      {/* Header */}
      <ProfileHeader
        profile={profile}
        isEditing={isEditing}
        isSaving={isSaving}
        onEditToggle={() => setIsEditing(!isEditing)}
        onSave={() => handleSaveProfile(profile)}
        onInputChange={onInputChange}
        onPreview={handlePreview}
      />

      {/* Main Content */}
      <div className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <ProfileTabs 
          activeTab={activeTab} 
          onTabChange={setActiveTab}
          tabs={[
            { id: 'overview', label: 'Overview', icon: <FileText className="w-4 h-4" /> },
            { id: 'experience', label: 'Experience', icon: <Briefcase className="w-4 h-4" /> },
            { id: 'education', label: 'Education', icon: <GraduationCap className="w-4 h-4" /> },
            { id: 'skills', label: 'Skills', icon: <Award className="w-4 h-4" /> },
          ]}
        />

        <div className="mt-6">
          <ProfileOverview
            activeTab={activeTab}
            profile={profile}
            experiences={experiences}
            education={education}
            skills={skills}
            certifications={certifications}
            isEditing={isEditing}
            onAddItem={handleAddItem}
            onEditItem={handleEditItem}
            onDeleteItem={handleDeleteItem}
            onInputChange={(e) => {
              const { name, value } = e.target;
              setProfile(prev => ({ ...prev, [name]: value }));
            }}
            onSave={() => handleSaveProfile(profile)}
            onCancel={() => setIsEditing(false)}
          />
        </div>
      </div>

      {/* Resume Preview Modal */}
      <ResumePreviewModal
        isPreviewOpen={isPreviewOpen}
        setIsPreviewOpen={() => setIsPreviewOpen(false)}
        profile={profile}
        certifications={certifications}
        languages={languages}
        experiences={experiences}
        education={education}
        skills={skills}
        formatDate={formatDate}
      />
    </div>
  );
}